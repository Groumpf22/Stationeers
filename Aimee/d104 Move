#Aimee d104 Movement

##################################
# define read/write addresses in d107 (input/gate)
##################################
define TetherX 0
define TetherY 1
define TetherZ 2
define SavedTargetX 3
define SavedTargetY 4
define SavedTargetZ 5
define PosX 6
define PosY 7
define PosZ 8
define OrderRTChute 9
define OrderMTMine 10
define Waiting 11
define Mining 12
define AtChute 13
define ShiftOrder 14
define OverrideReturn 15
define FinishedSpiral 16
define StayAtChute 17
##################################
# define read only addresses in d107 (gate only)
##################################
define DistPosToTarget 36
define AnyOrder 62
define BatteryLeft 63
##################################
# define stack addresses in d107 (lup only)
##################################
define ChargeMin 128
define XChute 129
define YChute 130
define ZChute 131
define X0Spiral 132
define Y0Spiral 133
define Z0Spiral 134
define NoGoXMin 135
define NoGoXMax 136
define NogoZMin 137
define NoGoZMax 138


alias Robot d0

alias BotOrder r0
alias RTC r1
alias BotMode r2
alias var5 r10
alias var4 r11
alias var3 r12
alias var2 r13
alias var1 r14
alias var0 r15

controlLoop:
yield
get BotOrder d107 OrderRTChute
beq BotOrder 1 returnToChute
get BotOrder d107 OrderMTMine
beq BotOrder 1 moveToMine
j controlLoop 

returnToChute:
put d107 OrderMTMine 0
get var0 d107 XChute
get var1 d107 YChute
get var2 d107 ZChute
j setTarget

moveToMine:
get var0 d107 TetherX
get var1 d107 TetherY
get var2 d107 TetherZ
j setTarget

setTarget:
s Robot TargetX var0
put d107 SavedTargetX var0
s Robot TargetY var1
put d107 SavedTargetY var1
s Robot TargetZ var2
put d107 SavedTargetZ var2
s Robot Mode RobotMode.MoveToTarget
sleep 2
get RTC d107 OrderRTChute
put d107 Waiting 1
put d107 OrderRTChute 0
put d107 OrderMTMine 0

waitForArrival:
yield
beqzal RTC checkReturn 
s Robot Mode RobotMode.MoveToTarget
sleep 2
l var0 Robot PositionY
s Robot TargetY var0
put d107 SavedTargetY var0
l var0 Robot Mode
bnez var0 waitForArrival  
get var0 d107 DistPosToTarget
bgt var0 2 waitForArrival  
j waitForArrival 
beqz RTC startMining
j atChute 

checkReturn:
get var0 d107 OrderRTChute
beqz var0 ra
put d107 Waiting 0
j controlLoop 

startMining:
put d107 Mining 1
put d107 Waiting 0
s Robot Mode RobotMode.Roam
j controlLoop

atChute:
put d107 AtChute 1
j controlLoop
