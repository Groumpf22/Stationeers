# Control of 1 fab in a loop of max 4 fabs, set stacker for quty
# use lever button, lever reset after printing, cancels if reseted manually

#
alias Display d5
#
alias Fab d0
alias Stack d1
alias Lever1 d2
alias Fab2 d3
alias Fab3 d4

alias Amount r0
alias ButtonActive r1
alias Instruction r2
alias PrintHash r3
alias Printing r4

clr Fab

buttonLoop:
yield
l ButtonActive Lever1 Setting
beq ButtonActive 0 buttonLoop  #loops if button not active

print:
s Fab Open 0
s Fab2 Open 1
s Fab3 Open 1
l Amount Stack Setting #get stacker amount
bgeal Amount 250 set250 #max 250, reduce if more
l PrintHash Fab RecipeHash #read recipe on fab
move Instruction 0 #reset instruction
put Fab 0 Instruction #reset fab command 0
sll Amount Amount 8 #add amount
or Instruction Instruction Amount
sll PrintHash PrintHash 16
or Instruction Instruction PrintHash
or Instruction Instruction PrinterInstruction.ExecuteRecipe #add op code print
put Fab 0 Instruction # print

printing:
yield #loop until printing finished
l Printing Fab Activate # Printing = 1 if WIP
l ButtonActive Lever1 Setting
beqz ButtonActive clearPrinter #lever on 0: cancel
get Instruction Fab 0
beqz Instruction reinitialize #Printing over: fab auto delete the line
j printing

set250:
move Amount 250
j ra

clearPrinter:
s Fab Activate 0
clr Fab
j buttonLoop

reinitialize:
s Lever1 Open 0
j buttonLoop
